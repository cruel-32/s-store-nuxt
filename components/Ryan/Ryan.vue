<template>
  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
    width="775" height="1078" viewBox="0 0 775 1078" id="ryan_wrap">
      <defs>
          <style>
          .cls-1 {
            opacity: 0.4;
          }
          .cls-2 {
            opacity: 0.35;
          }
        </style>
      </defs>
      <g id="art_board" data-name="art_board">
          <g id="ryon">
            <image id="shadow" class="cls-1" x="233" y="1017" width="334" height="64" xlink:href="data:img/png;base64,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"/>
            <RyanFire v-if="story.face == 'angry'" />
            <RyanLegs />
            <RyanRightHand :action="story.action" />
            <RyanLeftHand :action="story.action" />
            <RyanBody />
            <RyanEars
              :earsTransPosition="earsTransPosition"
              :earsOrigin="earsOrigin"
            />
            <RyanHead ref="head"
              :faceTransPosition="faceTransPosition"
              :faceOrigin="faceOrigin"
              :face="story.face"
              :action="story.action"
            />
            <RyanDepression  v-if="story.face == 'depression'"/>
          </g>
          <RyanFrontShadow v-if="story.face == 'angry'"/>
      </g>
  </svg>
</template>

<script>
import { mapGetters } from 'vuex'
import RyanFire from './RyanFire.vue'
import RyanLegs from './RyanLegs.vue'
import RyanRightHand from './RyanRightHand.vue'
import RyanLeftHand from './RyanLeftHand.vue'
import RyanBody from './RyanBody.vue'
import RyanEars from './RyanEars.vue'
import RyanHead from './RyanHead.vue'
import RyanDepression from './RyanDepression.vue'
import RyanFrontShadow from './RyanFrontShadow.vue'

export default {
  name : 'Ryan',
  props : [
    'mode'
  ],
  components : {
    RyanFire, RyanLegs, RyanRightHand, RyanLeftHand, RyanBody, RyanEars, RyanHead, RyanFrontShadow, RyanDepression
  },
  watch: {
    wsize(){
      this.init();
    },
    position(xy){
      if(this.mode == 'menu'){
        if(xy){
          const {rx,ry,angle} = this.getPositionByRect(xy,this.headRect);
          this.faceTransPosition = `rotate3d(${rx/angle}, ${ry/angle}, ${ry/angle}, ${angle/12}rad)`;
          this.earsTransPosition = `rotate3d(${rx/angle}, ${ry/angle}, ${ry/angle}, ${angle/20}rad)`;
        } else {
          this.faceTransPosition = 'rotate3d(1, 0, 0, 0)';
          this.earsTransPosition = 'rotate3d(1, 0, 0, 0)';
        }
      }
    }
  },
  computed : {
    ...mapGetters({
      wsize : 'wsize',
      position : 'position',
      story : 'story/story',
    }),
  },
  data(){
    return {
      headRect : null,
      faceTransPosition : 'rotate3d(1, 0, 0, 0)',
      earsTransPosition : 'rotate3d(1, 0, 0, 0)',
      faceOrigin : null,
      earsOrigin : null,
    }
  },
  mounted(){
    this.init();
  },
  methods : {
    init(){
      this.headRect = this.getClientRect(this.$refs['head'].$el);
      this.faceOrigin = `50% 50% -${this.headRect.width/2}px`;
      this.earsOrigin = `50% 50% ${this.headRect.width/2}px`;
    },
    getClientRect(obj){
      return obj.getBoundingClientRect();
    },
    getPositionByRect(xy, rect){
      const {x,y} = xy;
      const {left,top,width,height} = rect;
      const tx = left + width/2 - x;
      const yx = top + height/2 - y;
      const ry = Math.atan2(-tx , Math.abs(yx));
      const rx =  Math.atan2(yx, Math.abs(yx) / Math.cos(ry));
      const angle = Math.max(Math.abs(rx), Math.abs(ry));
      return {
        rx,ry,angle
      }
    }
  },
}
</script>

<style lang="scss">
#ryan_wrap {
  position:fixed;
  z-index:6;
  top:50%;
  left:50%;
  max-width : 800px;
  max-height : 700px;
  transform : translate(-50%, -50%) scale(1);
  transform-origin:50% 50%;
  #art_board {
    transform-origin:50% 50%;
  }
}
// transformorigin="387.5px 530px"
</style>